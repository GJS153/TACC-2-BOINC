<?php
// This file is part of BOINC.
// http://boinc.berkeley.edu
// Copyright (C) 2016 University of California
//
// BOINC is free software; you can redistribute it and/or modify it
// under the terms of the GNU Lesser General Public License
// as published by the Free Software Foundation,
// either version 3 of the License, or (at your option) any later version.
//
// BOINC is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
// See the GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with BOINC.  If not, see <http://www.gnu.org/licenses/>.

require_once("../inc/util.inc");
require_once("../inc/red_keys.inc");

page_head(null, null, null, null, null, "Job Submission Result");

check_get_args(array());

//Any website visitors who have not signed in yet will be
//redirected to the sign in page
$user = get_logged_in_user();
BoincForumPrefs::lookup($user);

if(isset($_FILES['file'])){
	//All information needed
	$organizationKey = get_ok("TACC");
	$token = "";
	$inputFile = $_FILES["file"];
	$fileName =  $_FILES["file"]["name"];
	$commandLine = $_POST["theCommandLine"];
	$commandLine = str_replace("\n", "", $commandLine);
	$commandLine = str_replace("\r", "", $commandLine);
	$dockerImg = "";
	if($_POST["dockerList"] != "none")
		$dockerImg = $_POST["dockerList"];
	if($_POST["dockerFileName"] != "none")
		$dockerImg = $_POST["dockerFileName"];
	$dockerImg = str_replace("\n", "", $dockerImg);
	$dockerImg = str_replace("\r", "", $dockerImg);	
	
	// Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
	// Get the user's token based on the user's email address
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, "http://0.0.0.0:5054/boincserver/v2/api/authorize_from_org");
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, "email=$user->email_addr&org_key=".$organizationKey);
	curl_setopt($ch, CURLOPT_POST, 1);
	$headers = array();
	$headers[] = "Content-Type: application/x-www-form-urlencoded";
	curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
	$result = curl_exec($ch);
	$token = $result;
		
	//Set up json
	$tempData = array('Token'=> $token, 'Boapp'=>'boinc2docker', 'Files'=> array($fileName),'Image'=> $dockerImg,'Custom'=> 'No','Command'=> $commandLine);
	$theJson = json_encode($tempData, JSON_UNESCAPED_SLASHES); 

	//End of getting user's token

	//Find out if the token API call is successful or not
	if (curl_errno($ch) || strpos($result, 'INVALID') !== false) {
		echo '<center><h1>'.tra('Sorry, your file was not uploaded.').'</center></h1>';
		if(strpos($result, 'INVALID') !== false){
			echo '<center><h3>'.tra($result).'</h3></center>';
		} else {
			echo '<center><h3>'.tra('Make sure to follow the requirements mentioned on Job Submission page for the input file').'</h3></center>';
		}
		
		curl_close($ch);
		echo '<a href="http://129.114.16.64/job_submission.php" class="btn btn-success" role="button">Go Back to Job Submission Page</a>';
	} else {
		
		//If successfull, put the files in reef account
		curl_close($ch);
		//https://www.w3schools.com/Php/php_file_upload.asp
		$target_dir = "/root/project/api/sandbox_files/DIR_".$token."/";
		$target_file = $target_dir . basename($fileName);
		
		if (move_uploaded_file($_FILES["file"]["tmp_name"], $target_file)) {
			// Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
			$ch = curl_init();

			curl_setopt($ch, CURLOPT_URL, "http://0.0.0.0:5096/boincserver/v2/api/process_web_jobs");
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
			curl_setopt($ch, CURLOPT_POSTFIELDS, $theJson);
			curl_setopt($ch, CURLOPT_POST, 1);

			$headers = array();
			$headers[] = "Content-Type: application/json";
			curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

			$result = curl_exec($ch);

			//Check whether calling json API was successful or not			
			if (curl_errno($ch) || strpos($result, 'INVALID') !== false) {
				echo '<center><h1>'.tra('Sorry, your file was not uploaded.').'</center></h1>';
				if(strpos($result, 'INVALID') !== false){
					echo '<center><h3>'.tra($result).'</h3></center>';
				} else {
					echo '<center><h3>'.tra('Make sure to follow the requirements mentioned on Job Submission page for the input file').'</h3></center>';
				}
				echo '<center><a href="http://129.114.16.64/job_submission.php" class="btn btn-success" role="button">Go Back to Job Submission Page</a></center>';
			} else {
				echo '<center><h1>'.tra('Congratulations, your file was uploaded.').'</center></h1>';
				echo '<center><a href="http://129.114.16.64/job_submission.php" class="btn btn-success" role="button">Go Back to Job Submission Page</a></center>';
			}
		
			curl_close ($ch);


    		} else {//If uploading file is not successful
        		echo '<center><h1>'.tra('Sorry, your file was not uploaded.').'</center></h1><center><h3>'.tra('Make sure to follow the requirements mentioned on Job Submission page for the input file').'</h3></center>';
			echo '<center><a href="http://129.114.16.64/job_submission.php" class="btn btn-success" role="button">Go Back to Job Submission Page</a></center>';
    		}
	}
} else{
	echo '<script type="text/javascript">location.href = "http://129.114.16.64/boincserver/job_submission.php";</script>';
}

page_tail();

?>
