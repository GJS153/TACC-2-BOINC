<?php
// This file is part of BOINC.
// http://boinc.berkeley.edu
// Copyright (C) 2016 University of California
//
// BOINC is free software; you can redistribute it and/or modify it
// under the terms of the GNU Lesser General Public License
// as published by the Free Software Foundation,
// either version 3 of the License, or (at your option) any later version.
//
// BOINC is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
// See the GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with BOINC.  If not, see <http://www.gnu.org/licenses/>.

require_once("../inc/util.inc");
require_once("../inc/red_keys.inc");

page_head(null, null, null, null, null, "Job Submission Result");

if (!isset($_SESSION))
{
    session_start(); 
}

if(!isset($_SESSION['user'])){
        echo "<script>window.location.replace('./login_as_a_researcher_form.php');</script>";
} else if(isset($_FILES['file'])){
	//All information needed
	$organizationKey = get_ok("TACC");
	$token = "";
	$reefIP = "";
	$reefKey = "";
	$inputFile = $_FILES["file"];
	$fileName =  $_FILES["file"]["name"];
	$commandLine = $_POST["theCommandLine"];
	$commandLine = str_replace("\n", "", $commandLine);
	$commandLine = str_replace("\r", "", $commandLine);
	$dockerImg = "";
	if($_POST["dockerList"] != "none")
		$dockerImg = $_POST["dockerList"];
	if($_POST["dockerFileName"] != "none")
		$dockerImg = $_POST["dockerFileName"];
	$dockerImg = str_replace("\n", "", $dockerImg);
	$dockerImg = str_replace("\r", "", $dockerImg);	
	
	/*Taken from Thomas' job history codes*/
	$ch3 = curl_init();
	curl_setopt($ch3, CURLOPT_URL, "http://0.0.0.0:5078/boincserver/v2/api/user_tokens/".$_SESSION['user']."/".$organizationKey);
	curl_setopt($ch3, CURLOPT_RETURNTRANSFER, 1);
	$result = curl_exec($ch3);
	/*if (curl_errno($ch3)) {
		echo 'Error:' . curl_error($ch3);
	}
	curl_close ($ch3);
	$tokenlist=explode(",", $retrieval);*/
	/*End of Thomas' copy */	

	/*$token = $tokenlist[0];*/		

	/*
	// Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
	// Get the user's token based on the user's email address
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, "http://0.0.0.0:5054/boincserver/v2/api/authorize_from_org");
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, "email=$user->email_addr&org_key=".$organizationKey);
	curl_setopt($ch, CURLOPT_POST, 1);
	$headers = array();
	$headers[] = "Content-Type: application/x-www-form-urlencoded";
	curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
	$result = curl_exec($ch);
	$token = $result;
	*/	
	
	//End of getting user's token

	//Find out if the token API call is successful or not
	if (curl_errno($ch3) || strpos($result, 'NOT') !== false) {
		echo '<center><h1>'.tra('Sorry, your file was not uploaded.').'</center></h1>';
		if(strpos($result, 'NOT') !== false){
			echo '<center><h3>'.tra($result).'</h3></center>';
		} else {
			echo '<center><h3>'.tra('Make sure to follow the requirements mentioned on Job Submission page for the input file').'</h3></center>';
		}
		
		curl_close($ch3);
		echo '<center><a href="./job_submission.php" style="font-weight: bold;" class="btn btn-success" role="button">Go Back to Job Submission Page</a></center>';
	} else {
		$tokenlist=explode(",", $result);
		$token = $tokenlist[0];
		
		//Set up json
	$tempData = array('Token'=> $token, 'Boapp'=>'boinc2docker', 'Files'=> array($fileName),'Image'=> $dockerImg,'Custom'=> 'No','Command'=> $commandLine);
	$theJson = json_encode($tempData, JSON_UNESCAPED_SLASHES); 		

		//If successfull, put the files in reef account
		curl_close($ch3);

		//Get the reef key and IP
		$ch = curl_init();

		curl_setopt($ch, CURLOPT_URL, "http://0.0.0.0:6071/boincserver/v2/api/env/reef");
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

		$result = curl_exec($ch);
		$result = json_decode($result, true);
		$reefKey = $result["Reef_Key"];
		$reefIP = $result["Reef_IP"];
		curl_close ($ch);

		//https://www.w3schools.com/Php/php_file_upload.asp
		/*$target_dir = "/root/project/api/sandbox_files/DIR_".$token."/";
		$target_file = $target_dir . basename($fileName);
		
		if (move_uploaded_file($_FILES["file"]["tmp_name"], $target_file)) {*/

		// Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/	
		//curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
		if (function_exists('curl_file_create')) { // php 5.5+
  			$cFile = curl_file_create($_FILES['file']['tmp_name']);
		} else { // 
  			$cFile = '@' . realpath($_FILES['file']['tmp_name']);
		}
		$ch = curl_init();
		$url = "http://".$reefIP.":2000/reef/upload/".$reefKey."/".$token; 
		curl_setopt($ch, CURLOPT_URL, $url);
		curl_setopt($ch, CURLOPT_POST, 1);
		curl_setopt($ch, CURLOPT_POSTFIELDS,
    			array('file' =>$cFile,'filename'=>$fileName));		
		/*curl_setopt($ch, CURLOPT_SAFE_UPLOAD, false);		

		$headers = array();
		$headers[] = "Content-Type: application/x-www-form-urlencoded";
		curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
		*/
		$result = curl_exec($ch);
		
		if (!curl_errno($ch) && strpos($result, 'INVALID') === false) {
			curl_close ($ch);
			
			// Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
			$ch = curl_init();

			curl_setopt($ch, CURLOPT_URL, "http://0.0.0.0:6035/boincserver/v2/api/process_web_jobs");
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
			curl_setopt($ch, CURLOPT_POSTFIELDS, $theJson);
			curl_setopt($ch, CURLOPT_POST, 1);

			$headers = array();
			$headers[] = "Content-Type: application/json";
			curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

			$result = curl_exec($ch);

			//Check whether calling json API was successful or not			
			if (curl_errno($ch) || strpos($result, 'INVALID') !== false) {
				echo '<center><h1>'.tra('Sorry, your file was not uploaded.').'</center></h1>';
				if(strpos($result, 'INVALID') !== false){
					echo '<center><h3>'.tra($result).'</h3></center>';
				} else {
					echo '<center><h3>'.tra('Make sure to follow the requirements mentioned on Job Submission page for the input file').'</h3></center>';
				}
				echo '<center><a href="./job_submission.php" class="btn btn-success" role="button">Go Back to Job Submission Page</a></center>';
			} else {
				echo '<center><h1>'.tra('Congratulations, your file was uploaded.').'</center></h1>';
				echo '<center><a href="./job_submission.php" style="font-weight:bold" class="btn btn-success" role="button">Go Back to Job Submission Page</a></center>';
			}
		
			curl_close ($ch);


    		} else {//If uploading file is not successful
        		echo '<center><h1>'.tra('Sorry, your file was not uploaded.').'</center></h1><center><h3>'.tra('Make sure to follow the requirements mentioned on Job Submission page for the input file').'</h3></center>';
			echo '<center><a href="./job_submission.php" style="font-weight:bold;" class="btn btn-success" role="button">Go Back to Job Submission Page</a></center>';
    		}
	}
} else{
	echo '<script type="text/javascript">location.href = "./job_submission.php";</script>';
}

page_tail();

?>
